---
title: "EDA_CDCFluView"
author: "Niat Kashsay, Celina Velazquez, Nancy Walker"
format: 
  pdf:
    keep-tex: true
    include-in-header:
      text: |
        \usepackage{float}      % enables [H]
        \usepackage{placeins}   % provides \FloatBarrier
        \floatplacement{figure}{H}
        \floatplacement{table}{H}
execute:
  echo: true
  results: asis                    # show results inline
  warning: false
  message: false
---

# EDA of the CDCFluView Dataset 

The dataset researched comes from the CDC FLUVIEW.

https://gis.cdc.gov/grasp/fluview/fluportaldashboard.html

Data was accessed on October 31, 2025, using the Influenza-Like Illness Network (ILINet) endpoint. Analyses reflect weekly ILI values available up to that date. 

Weekly ILI data for California were obtained from CDC ILINet (1997–present). For modeling, data from 2010 to 2025 were used to ensure consistent reporting and reliable seasonal structure. This dataset displays weekly influenza data. Influenza incidence can inform public health decision-making, such as surveillance, hospital capacity, and vaccination strategies. Although the CDC FLUVIEW provides influenza data nationwide, tailoring a project to Region 9 (California, Arizona, Hawaii, Nevada, and Pacific territories) provides stable weekly data that models well and yields a high-quality forecasting model. 

## Import libraries

```{r}
#| message: false
library(tidyverse)
library(fpp3)
library(janitor)   # for clean_names()
library(MMWRweek) 
library(gt)
library(corrplot)
```

## Read the Data 

```{r}
ili_raw <- read_csv("data/raw/ILINet.csv", 
                   skip =1, 
                   na = c("", "NA"),
                   show_col_types = FALSE)

# Make column names easy to use 
# For example, % Weighted ILI to percent_weighted_ili
ili <- ili_raw |>
  clean_names() |>
  # keep only Region 9 
  # (California, Arizona, Hawaii, Nevada, and pacific territories) 
  filter(region_type == "HHS Regions", region == "Region 9") |>
  # Create a simple sequence for weeks (1:nrow)
  mutate(
    # Create a true calendar date for the CDC week ending (MMWR day 7 = Sunday)
    week_end = MMWRweek2Date(MMWRyear = year, MMWRweek = week, MMWRday = 7)
  ) |>
  filter(!is.na(week_end)) |>
  as_tsibble(index = week_end)

# head(ili) 
```

## EDA

```{r}
# View Structure 
str(ili) 
```

Time index intervals are weekly (interval = 7D, regular = TRUE). Date is set as a tsibble index. Only Region 9 is selected. 

```{r}
# Check for null values 
anyNA(ili)
# Count null values 
sum(is.na(ili))
# Count by column 
colSums(is.na(ili))
```

Only age_25_64 has missing values and all entries are missing. All other columns have no missing values. This variable can be excluded from the dataset. This variable may be harmless mathematically but dropping it will avoid potential confusions and error. 

```{r}
# drop age_25_64 column form dataset 
ili <- ili |> select(-age_25_64)
# Rename age_65 to age_65_plus for clarity
ili <- ili |> 
  rename(age_65_plus = age_65)
```

```{r}
# View Summary 
summary(ili)
```

There are 781 observations, which is about 15 years of data from 2010 to 2025. The frequency of the data is weekly. Both short-term fluctuations and long-term seasonality can be analysed. 

*Target Variable* 

The target Time series variable is percent weight ili, representing the proportion of patient visits due to influenza-like illness (ILI) in Region 9, weighted by provider volume.

*Other Variables* 

Predictors (potentially explanatory) — e.g., age-group counts, number of providers, total patients.

Metadata or identifiers — e.g., year, week, region.

Alternative measures — e.g., percent_unweighted_ili (a variant of the same phenomenon).

### Trend and Seasonality 

```{r}
# Line plot of % Weighted ILI (overall trend)
autoplot(ili, percent_weighted_ili) +
  labs(title = "Region 9: % Weighted ILI (Weekly, 2010–2025)",
       y = "% ILI", x = "Week Ending Date")

ili |> 
  ggplot(aes(week_end, percent_unweighted_ili)) + 
  geom_line() + 
  # Apply the generalized additive model "gam"
  # Draw a flexible smooth curve throughout the data usign cubic splines 
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "cs"), se= FALSE) + 
  labs(title= "Weekly Weighted ILI (%) _ HHS Region 9", 
          subtitle = "Smoothed Trend Using Generalized Additive Model",
          x = "Week Ending Date",
          y = "Weighted ILI (%)")

```
```{r}
# Seasonal pattern across years
gg_season(ili, percent_weighted_ili, period = "year") +
  labs(title = "Seasonality by Year: % Weighted ILI",
       y = "% ILI", x = "Week of Year")

# decomposition plot 
ili |> 
  model (stl = STL(percent_weighted_ili)) |> 
  components() |> 
  autoplot()
```

The time series of percent weighted ILI displays a clear seasonal pattern and fluctuating trend over time. Recurring peaks during winter months that reflect typical influenza seasonality. Around 2020, when the COVID-19 pandemic began a pronounced decline in influenza-like illness is observed. Following this period, influenza activity gradually increases indicating post-pandemic patterns. 

### Distribution and Outliers 

```{r}
# Boxplot 
boxplot(ili$percent_weighted_ili,
        main = "Boxplot of percent_weighted_ili")

# Boxplot by year
ili |>
  mutate(year = factor(year(week_end))) |>
  ggplot(aes(year, percent_weighted_ili)) +
  geom_boxplot(outlier.alpha = 0.4, fill = "lightblue") +
  labs(title = "% Weighted ILI by Year", x = "Year", y = "% ILI")

# Histogram of %ILI values
ili |> 
  ggplot(aes(percent_weighted_ili)) +
  geom_histogram(bins = 40, fill = "skyblue", color = "white") +
  labs(title = "Distribution of % Weighted ILI", x = "% ILI")

```

Percent_weighted_ili is the target time series variable. Boxplots and histograms indicate a right skew in the % weighted Ili data, with a few outliers. This suggest that most weekly observations fall within relatively low ILI percentages, with a few outlying high values corresponding to peak flu seasons. Boxplots of ILI, partitioned by year show influenza activity that demonstrates annual fluctuations consistent with seasonal outbreaks. 

### Related Series and Context

**Weighted vs Unweighted Comparison** 
```{r}
# Compare weighted vs unweighted variables 
ili |>
  select(week_end, percent_weighted_ili, percent_unweighted_ili) |>
  pivot_longer(-week_end, names_to = "metric", values_to = "value") |>
  ggplot(aes(week_end, value, color = metric)) +
  geom_line() +
  labs(title = "Weighted vs Unweighted % ILI", x = "Week", y = "% ILI") 
```

percent_unweighted_ili and percent_weighted_ili give very similar data because they are both measuring flu occurrences. Since percent_weight_ili is the sstandardized CDC metric it will be used as the target variable for analysis. 

```{r}
# Reporting coverage over time
ili |>
  pivot_longer(c(num_of_providers, total_patients),
               names_to = "measure", values_to = "value") |>
  ggplot(aes(week_end, value)) +
  geom_line() +
  facet_wrap(~ measure, scales = "free_y", ncol = 1) +
  labs(title = "Reporting Context: Providers & Patients", x = "Week")
```

The reporting context provides important background for interpreting ILI trends. Both the total number of providers participating in CDC’s ILI surveillance network and the total number of patients seen weekly show notable structural changes after 2020. Post 2020, the total number of providers reporting influenza like occurrences and the total number of patients has increased, Leveling off around 2023/2024. 

### Age Group Insight

```{r}
age_cols <- c("age_0_4","age_5_24","age_25_49","age_50_64","age_65_plus")

ili |>
  select(week_end, all_of(age_cols)) |>
  pivot_longer(-week_end, names_to = "age_group", values_to = "count") |>
  ggplot(aes(week_end, count)) +
  geom_line() +
  facet_wrap(~ age_group, scales = "free_y", ncol = 2) +
  labs(title = "Weekly ILI Counts by Age Group", x = "Week End", y = "Count")
```

Weekly counts of ILI by age group reveal a consistent seasonal pattern across all demographics. However, there is a noticeable increase in ILI patients for each age group around 2023/2024. This is consistent with the number of providers reporting and total patients increasing which is a broader resurgence in influenza activity and healthcare reporting, not an isolated demographic shift. 

###Correlation Checks

```{r}
# make it a plain tibble, keep only numeric columns
ili_num <- ili |>
  as_tibble() |>
  select(where(is.numeric))

# Simple correlation matrix (numeric vars only)
ili_cor <- cor(ili_num, use= "pairwise.complete.obs")

corrplot(ili_cor, method = "color", type = "lower",
         tl.col = "black", tl.srt = 45)

# Focus on correlation with target variable
sort(ili_cor["percent_weighted_ili", ], decreasing = TRUE)
```

Correlation analysis shows that most variables are positively correlated with percent weighted ILI, indicating that increases in overall ILI activity tend to occur alongside increases in other related measures. The highest correlation is between percent weight ILI and percent unweighted ILI. These variables measure similar occurrences. Percent weight ILI is moderately correlated with age groups, providers, and the number of patients, suggesting that higher total ILI percentages coincide with higher case counts across all demographic groups. Percent weight ILI is weekly correlated with year and week, showing that temporal indexing does not drive ILI variation. Overall, parent-weighted ILI is proving to be a comprehensive indicator of influenza activity that closely aligns with both the unweighted percentage and raw age-specific case counts, while remaining influenced by broader reporting and population dynamics.  

**Autocorrelation and Stationarity** 
```{r}
# Autocorrelation Function (ACF)
ACF(ili, percent_weighted_ili) |> autoplot() +
  labs(title = "Autocorrelation (ACF): % Weighted ILI")

# Partial Autocorrelation Function (PACF)
PACF(ili, percent_weighted_ili) |> autoplot() +
  labs(title = "Partial Autocorrelation (PACF): % Weighted ILI")
```

ACF plot shows decaying correlation across many lags indicating non-stationary trend or present seasonality. PACF plot show significant spikes at short lags indicating short-term auto regressive dependence. Transformations will be helpful prior to analysis with ARIMA models. 

## Transformations 

### Stationarity  

```{r}
ili_weight <-ili |> 
  select (week_end, percent_weighted_ili) |> 
  filter(week_end >= as.Date("2015-01-03"),
         week_end <= as.Date("2025-06-28")) |> 
  as_tsibble(index = week_end)

autoplot(ili_weight, percent_weighted_ili) + 
  ggtitle('Percent Weighted ILI 2015-2025')

```
Is the series stationary 

No, this series has seasonality and heteroskedasticit. There is also trend that increases post 2020. 

Lag intervals are 7D  or 7 days. Each observation represents one week of data, not daily data. Lag = 1 means one week ago. 

```{r}
ili_weight |> gg_tsdisplay(percent_weighted_ili)
```

```{r}
# Normalization 
ili_weight |> 
  mutate (log_v = log(percent_weighted_ili)) |> 
  autoplot(log_v)
```

Constant variance, but trend and seasonality are present.

```{r}
#| echo: true
#| warning: false
#| fig.height: 3
#| fig.cap: "Trend is removed, but seasonality exists."
# non-seasonal differencing 
ili_weight |> 
  mutate(log_v =log(percent_weighted_ili),
         d1 = difference(log_v, lag=1)) |> 
  autoplot(d1)
```
```{r}
#| echo: true
#| warning: false
#| fig.height: 3
#| fig.cap: Seasonality is removed, but trend exists.
# Seasonal Differencing
ili_weight |> 
  mutate(
  log_v = log(percent_weighted_ili),
   # use 52 for weekly seasonality 
  D52 = difference(log_v, lag = 52)) |>
  autoplot(D52)
```

```{r}
#| echo: true
#| warning: false
# Combined differencing 
ili_prepped <- ili_weight |> 
  mutate(
  log_v = log(percent_weighted_ili),
   # use 52 for weekly seasonality 
  D52 = difference(log_v, lag = 52),
  d1 = difference(log_v, lag = 1),
  D52d1 = difference(D52, lag =1)) 

ili_prepped |> autoplot(D52d1)
```

Data looks like stationary. Do statistical test. 

```{r}
ili_prepped |> 
  features(D52d1, unitroot_kpss) |> 
  gt :: gt()
```

The p-value is larger than 0.05 therefore we fail to reject the null hypothesis. The differenced log-transformed series D52d1 is stationary. 

```{r}
# fragment 

ili_prepped |> 
  features(log_v, c(unitroot_kpss, unitroot_ndiffs, unitroot_nsdiffs)) |> 
  gt:: gt()
```

The raw log-transformed series is non-stationary with a p-value less than 0.05. The model recommends one regular difference with ndiffs equal to one. However, no additional seasonal difference is needed with nsdiffs equal to zero.

### Modeling 

```{r}
# Choose a weekly cutoff 
cutoff <- max(ili$week_end) - weeks(52)

ili_trn <- ili |> filter(week_end <= cutoff)
ili_test <- ili |> filter(week_end > cutoff)

# Fit baseline ARIMA models (raw vs log)
ili_trn_arima <- ili_trn |> 
  model(
    arima_raw = ARIMA(percent_weighted_ili),
    arima_log = ARIMA(log(percent_weighted_ili))
  )

ili_trn_arima |> 
  select(arima_raw) |> 
  gg_tsresiduals(type = "innovation")
```

Are the residuals white noise? 
```{r}
ili_trn_arima['arima_raw'] |> 
  augment() |> 
  autoplot(.innov)
```

```{r}
# perform a ljung-box test with sufficient lags
ili_trn_arima['arima_raw'] |> 
  augment() |> 
  features(.innov, c(ljung_box, box_pierce), lag=52) |> 
  select(.model, contains('pvalue')) |> 
  gt::gt()
```
The residuals from the current ARIMA model are not white noise. Autocorrelation remains in the residuals. The model is missing seasonal and autoregressive terms. This is indicated by the p-values that are extremely below 0.05. The null hypothesis is rejected. 

```{r}
# Repeat ljung-box test for arima_log
ili_trn_arima['arima_log'] |> 
  augment() |> 
  features(.innov, c(ljung_box, box_pierce), lag=52) |> 
  select(.model, contains('pvalue')) |> 
  gt::gt()
```

On the log transformed data, p-values remain small, both under the 0.05 threshold. Therefore we reject the null hypothesis that the residuals are independent. Residuals are still autocorrleated after log transformations. Both models are underfitting that data and do not handle the annual (52-week) seasonality or short-term autocorrelation revealed in ACF.PACF plots. 

### Modeling with Transformations 
```{r}
# Define training cutoff (exclude last year)
trn_cutoff <- max(ili$week_end) - years(1)

ili_trn_prep <- ili_prepped |>
  filter(week_end <= trn_cutoff)

# Fit multiple ARIMA and ETS models with transformations 
ili_trn_fit <- ili_trn_prep |>
  model(
    arima_logv = ARIMA(log(percent_weighted_ili)),
    arima_log1p = ARIMA(log1p(percent_weighted_ili)),
    arima_sqrt = ARIMA(sqrt(percent_weighted_ili)),
    arima_v = ARIMA(percent_weighted_ili),
    ets_logv = ETS(log(percent_weighted_ili)),
    ets_v = ETS(percent_weighted_ili)
  )

# Forecast 1 year (52 weeks) ahead 
ili_fc_52 <- ili_trn_fit |> forecast(h = 52)

ili_fc_52 |>
  accuracy(ili) |>
  arrange(RMSE) |> 
  gt() |>
  fmt_number(decimals = 2) |>
  tab_header(
    title= ("Model Accuracy Comparison"),
    subtitle = ("Forecast performance over 52-week horizons")
  )
```

In this analysis we forecast 1 year of data and compare to about 4 month data. One year forecast assess the model's ability to capture full seasonal cycles. In the final project or applied context, we may revert to 12–20 week forecasts if aim is Real-time influenza surveillance, or Comparison to CDC’s own short-term outlooks.

The best overall accuracy for the 52-week horizon is arima_v with an RMSE of 2.14. Transformations did not help ARMIA modeling in this case. ETS lag is decent but not better than ARIMA. For 1-year forecast arima_v is the primary model.

### Confifence Intervals/Transformations 
```{r}
#| fig-width: 22
#| fig-height: 10
ili_fc_52 |> 
  autoplot(level = 95) +
  facet_wrap(~ .model) +
  autolayer(
    ili |> filter(week_end > trn_cutoff),
    percent_weighted_ili,
    color = "black"
  ) +
  labs(
    title = "Forecast vs Actual Influenza-Like Illness (ILI) Activity",
    subtitle = "Weekly % Weighted ILI, 2024–2025 Forecast",
  )  +
  theme_minimal(base_size = 20)  # << increases all font sizes
```

The default (non-seasonal) ARIMA and ETS fits are producing unrealistic long-range trajectories because they haven’t yet been told how to handle your dataset’s strong yearly seasonality.

#### Handle the COVID-19 structural Break 

The COVID-19 period (about 2020 to 2021) creates a level shift in the data. ARIMA assumes that the fluctuations come from the same process through time. When a massive one-time drop happens it assumes that it is part of the pattern yielding a forecast that does not reflect the data structure. Include a dummy regressor that singles the pandemic period. 

Test whether the COVID-era structural break should be handled during preprocessing or later via a covariate.

```{r}
#| echo: true
#| warning: false
# Used Chat GPT to figure out how to create a pandemic period dummy variable 
# and check the diagnostics of that variable 

# Create a dummy variable for the pandemic period
ili <- ili |> 
  mutate(
    pandemic = if_else(
      week_end >= ymd("2020-03-01") & week_end <= ymd("2022-01-01"),
      1, 0
    )
  )

# Fit ARIMA with exogenous regressor
ili_fit_covid <- ili |> 
  model(
    arima_covid = ARIMA(
      log1p(percent_weighted_ili) ~ pandemic + PDQ(0,1,1,52)
    )
  )

ili_fit_covid |> report() |>
  knitr::kable(digits=0)
```
The seasonal ARIMA with a structural regressor, and the diagnostics confirm it’s a solid, well-behaved model.
```{r}

```

```{r}
# This step renames some variables previously created

# training split (hold out last 52 weeks)
trn_cutoff <- max(ili$week_end) - weeks(52)
ili_trn_prep <- ili |> filter(week_end <= trn_cutoff)
ili_tst <- ili |> filter(week_end > trn_cutoff)   # observed holdout

# Include pandemic in each ARIMA model
ili_trn_fit <- ili_trn_prep |>
  model(
    arima_logv = ARIMA(log(percent_weighted_ili) ~ pandemic),
    arima_log1p = ARIMA(log1p(percent_weighted_ili) ~ pandemic),
    arima_sqrt = ARIMA(sqrt(percent_weighted_ili) ~ pandemic),
    arima_v = ARIMA(percent_weighted_ili ~ pandemic),
    arima_covid = ARIMA(log1p(percent_weighted_ili) ~ pandemic + PDQ(0,1,1,52)),
    # Skip pandemic dummy for ETS models 
    ets_logv = ETS(log(percent_weighted_ili)),
    ets_v = ETS(percent_weighted_ili)
  )

# Use the held-out 52 weeks as new_data (ensure xreg present; it's 0 post-COVID)
new_52 <- ili_tst |> mutate(pandemic = 0)

# Forecast 
ili_fc_52 <- forecast(ili_trn_fit, new_data = new_52)

ili_fc_52 |>
  accuracy(ili) |>
  arrange(RMSE) |> 
  gt() |>
  fmt_number(decimals = 2) |>
  tab_header(
    title= ("Model Accuracy Comparison"),
    subtitle = ("Forecast performance over 52-week horizon with COVID-19 period **adjusted** (ARIMA xreg)")
  )
```

Adding the pandemic dummy to other ARIMA models helped, but the models still need explicit seasonal structure (D=1 and seasonal MA/AR at period 52). However the arima_covid model dramatically improved the RMSE results by roughly half the error of all other models. The signals of this model are much closer to white noise. 

```{r}
#| fig-width: 25
#| fig-height: 15
ili_fc_52 |> 
  autoplot(level = 95) +
  facet_wrap(~ .model) +
  autolayer(
    ili |> filter(week_end > trn_cutoff),
    percent_weighted_ili,
    color = "black"
  ) +
  labs(
    title = "Forecast vs Actual Influenza-Like Illness (ILI) Activity",
    subtitle = "Weekly % Weighted ILI, 2024–2025 Forecast",
  )  +
  theme_minimal(base_size = 20)  # << increases all font sizes
```

arima_covid (top-left) tracks the observed peak far better than the others — it’s the only one that visibly anticipates a realistic flu season peak around winter 2024–2025, then decays toward baseline.

```{r}
#| echo: true
ili_trn_fit |> t()
```
Seven models were compared, including four non-seasonal ARIMA models with various transformations (log, log1p, sqrt, raw), one pandemic-adjusted seasonal ARIMA model, and two exponential smoothing models (ETS). The non-seasonal ARIMA models captured short-term dependencies but failed to model annual flu seasonality or pandemic-related level shifts. The pandemic-adjusted ARIMA(2,0,1)(0,1,1)[52] with a COVID-19 dummy variable (arima_covid) incorporated both seasonal differencing and an exogenous regressor, resulting in the lowest RMSE (1.30) and most stationary residuals. ETS models provided smoother trends but struggled with structural changes and overfitting during the pandemic period.

**Best Model**

arima_covid: ARIMA(2,0,1)(0,1,1)[52] + pandemic

Combines weekly differencing, annual seasonality (period = 52), and a dummy for COVID → best model by RMSE and residual independence.

## Refrences

OpenAI. (2025). ChatGPT (November 12 version) [LargeLanguage Model]
OpenAI. (2025). ChatGPT (November 14 version) [LargeLanguage Model]