---
title: "CDC Flu View Times Series Models"
author: "Niat Kashsay, Celina Velazquez, Nancy Walker"
format: 
  pdf:
    keep-tex: true
    include-in-header:
      text: |
        \usepackage{float}      % enables [H]
        \usepackage{placeins}   % provides \FloatBarrier
        \floatplacement{figure}{H}
        \floatplacement{table}{H}
execute:
  echo: true
  results: asis                    # show results inline
  warning: false
  message: false
---

# Applying the Times Series Models to CDC Flu View Dataset 

In this document, several models will be applied and compared. The models performed include ETS (Error, Trend, and Seasonality), TSLM (Time Series Linear Model), and ARIMA (Autoregressive Integrated Moving Average). 

```{r}
#| message: false
library(tidyverse)
library(fpp3)
library(janitor)   # for clean_names()
library(MMWRweek) 
library(gt)
```

# Forecasting CDC FLu View Dataset 
```{r}
# Read the data 
ili_raw <- read_csv("data/raw/ILINet.csv", 
                   skip =1, 
                   na = c("", "NA"),
                   show_col_types = FALSE)

# Make column names easy to use 
# For example, % Weighted ILI to percent_weighted_ili
ili <- ili_raw |>
  clean_names() |>
  # keep only Region 9 
  # (California, Arizona, Hawaii, Nevada, and pacific territories) 
  filter(region_type == "HHS Regions", region == "Region 9") |>
  # Create a simple sequence for weeks (1:nrow)
  mutate(
    # Create a true calendar date for the CDC week ending (MMWR day 7 = Sunday)
    week_end = MMWRweek2Date(MMWRyear = year, MMWRweek = week, MMWRday = 7)
  ) |>
  filter(!is.na(week_end)) |>
  as_tsibble(index = week_end)

# meaningful time-series measures 
# Exclude week and year because they do not reflect flu activity 
metrics <- c(
  "percent_weighted_ili", "percent_unweighted_ili",
  "age_0_4", "age_5_24", "age_25_49", "age_50_64", "age_65",
  "ilitotal", "total_patients", "num_of_providers"
)

ili_long <- ili |> 
  select(week_end, any_of(metrics)) |>
  pivot_longer(cols = -week_end, names_to = 'Metric', values_to = 'Value') 

# SHow every numeric colimn in ILINet Region 9 dataset plotted overtime.
ili_long |> 
    ggplot(aes(week_end, Value)) +
    geom_line() +
    facet_wrap(~ Metric, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

This faceted line chart tracks key ILINet metrics for HHS Region 9 (CA, AZ, HI, NV, Pacific territories) over time. Panels include % weighted ILI, % unweighted ILI, age-specific ILI visit counts, total ILI visits (ilitotal), total patients, and number of providers. Age panels show large spikes around 2020–2023, consistent with COVID-era dynamics. Ili total counts the total visit counts across Region 9 (California, Arizona, Hawaii, Nevada, and Pacific territories). Total patients and providers also shift during this period, reflecting reporting changes.The primary measures the CDC uses for ILI severity are percent-weighted and unweighted ILI. These metrics show seasonal spikes every winter. For forecasting, focus on percent weighted ILI and compare ETS, TSLM (trend + yearly seasonality), and ARIMA. 

Percent Weighted ILI is the official CDC influenza surveillance metric that adjusts each provider’s contribution based on the number of patient visits they report. High-volume clinics receive greater weight, while small clinics contribute proportionally less. The CDC also incorporates additional adjustments for clinic visit volume, regional population representation, provider type, and variability in week-to-week participation. As a result, % Weighted ILI provides a more stable, population-representative, and less volatile estimate of influenza-like illness activity compared to the unweighted measure, which is simply the proportion of ILI visits out of total weekly patient visits without any weighting.

## Create ACF/PACF plots from a training set 

- Partition the dataset using period 2015-2025 as the training period and test on the most recent 12-20 weeks. 
  - Training period: week_end = 2015-01-03 to 2025-06-28
  - Testing period: week_end = 2025-07-05 to 2025-09-20
  - This will include the COVID impact, recovery years, and avoid pre-2010 regime, and allow models to learn from current amplitude levels. 
- Determine the differencing (if any) required to make the data stationary 
- Plot ACF/PACF on the stationary time series
- specify the modle suggestions by the ACF and PACF plots. 

```{r}
# Create a time series object for percent-weighted ILI 
ili_trn <- ili |> 
  select(week_end, percent_weighted_ili) |> 
  filter(week_end >= as.Date("2015-01-03"),
         week_end <= as.Date("2025-06-28")) |> 
  as_tsibble(index = week_end)

# Create a validation set for the model 
ili_valid <- ili |> 
  select(week_end, percent_weighted_ili) |> 
  filter(week_end > as.Date("2025-06-28")) |> 
  as_tsibble(index = week_end)

# Check stationarity (fabletools:: feature(...))
ili_trn |> 
  features(percent_weighted_ili, c(unitroot_kpss, unitroot_ndiffs, unitroot_nsdiffs)) |> 
  gt::gt()
```
The p-value is very small (<0.05), therefore KPSS test rejects the null hypothesis of stationary. This series is non stationary and requires differencing for ARIMA modeling. 

ndiffs =1 or one regular difference, thesefore the overall trend/nonstationarity is level.

nsdiffs = 0 or no seasonal differencing required. The sereise doesn't have strong deterministic seasonal unit root to require differencing. 

This is expected becuase Influenza seasonality is real but not perfectly stable by year. Also, COVID distored seasonal patterns. Weighted ILI has strong seasonal structure but ot a seasoanl unit root. 

```{r}
#| fig-height: 7

# Plot differenced series and ACF/PACF plots 
ili_trn |> 
  gg_tsdisplay(
    difference(percent_weighted_ili, lag = 1),
    plot_type = "partial",
    lag_max = 60 # see seasonal lags near 52 
  )
```

**What models do the ACF and PCF suggest would be best, respectively?**

